<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificateur de trajet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/main.css">
</head>
<body>
    <div class="navigation-panel">
        <h2>Planifiez votre Trajet</h2>
        <form method="POST" action="/calculate_route" class="details-panel">
            <div class="form-group">
                <label for="origin_city">Ville de départ</label>
                <input type="text" class="form-control" id="origin_city" name="origin_city" required>
            </div>
            <div class="form-group">
                <label for="destination_city">Ville d'arrivée</label>
                <input type="text" class="form-control" id="destination_city" name="destination_city" required>
            </div>
            <div class="form-group">
                <label for="car_id">Choisir un véhicule</label>
                <select class="form-control" id="car_id" name="car_id" required>
                    {% for car in vehicles %}
                    <option value="{{ car.id }}">
                        {{ car.naming.make }} {{ car.naming.model }} (Autonomie : {{ car.range.chargetrip_range.best }} km)
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Calculer</button>
        </form>
        <div id="result" class="details-panel" style="display: none;">
            <h4>Informations sur le Trajet</h4>
            <p id="distance"></p>
            <p id="duration"></p>
        </div>
    </div>
    <div id="mapContainer"></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var mapView = L.map('mapContainer').setView([48.8566, 2.3522], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Données &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(mapView);

        $('form').submit(function(event) {
            event.preventDefault();
            var formData = $(this).serialize();

            $('#result').hide();
            mapView.eachLayer(function(layer) {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    mapView.removeLayer(layer);
                }
            });

            $.post('/calculate_route', formData, function(response) {
                if (response.error) {
                    alert(response.error);
                    return;
                }

                var route = response.route_path;
                var stations = response.charging_stations;
                var latlngs = route.map(coord => [coord[0], coord[1]]);

                var polyline = L.polyline(latlngs, { color: 'blue' }).addTo(mapView);

                var start = latlngs[0];
                var end = latlngs[latlngs.length - 1];
                L.marker(start).bindPopup('Départ').addTo(mapView);
                L.marker(end).bindPopup('Arrivée').addTo(mapView);

                stations.forEach(station => {
                    var stationCoords = station.location.coordinates;
                    L.marker([stationCoords[1], stationCoords[0]])
                        .bindPopup(`<b>${station.name}</b><br>Puissance : ${station.power || 'N/A'} kW`)
                        .addTo(mapView);
                });

                mapView.fitBounds(polyline.getBounds());

                $('#distance').text('Distance totale : ' + response.total_distance);
                $('#duration').text('Durée estimée : ' + response.travel_time);
                $('#result').show();
            }).fail(function() {
                alert('Une erreur est survenue. Veuillez réessayer.');
            });
        });
    </script>
</body>
</html>
